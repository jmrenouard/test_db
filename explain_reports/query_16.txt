QUERY:
WITH DeptAvg AS (SELECT de.dept_no, AVG(s.salary) as avg_sal FROM dept_emp de JOIN salaries s ON de.emp_no = s.emp_no WHERE s.to_date = '9999-01-01' GROUP BY de.dept_no), GlobalAvg AS (SELECT AVG(salary) as glob_sal FROM salaries WHERE to_date = '9999-01-01') SELECT d.dept_name, da.avg_sal FROM DeptAvg da JOIN departments d ON da.dept_no = d.dept_no JOIN GlobalAvg ga WHERE da.avg_sal > ga.glob_sal

EXPLAIN PLAN:
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	d	index	PRIMARY	dept_name	162	NULL	9	Using index
1	PRIMARY	<derived2>	ref	key0	key0	16	employees.d.dept_no	1	
1	PRIMARY	<derived3>	ALL	NULL	NULL	NULL	NULL	2838426	Using where; Using join buffer (flat, BNL join)
2	LATERAL DERIVED	de	ref	PRIMARY,dept_no	dept_no	16	employees.d.dept_no	1	Using index
2	LATERAL DERIVED	s	ref	PRIMARY	PRIMARY	4	employees.de.emp_no	9	Using where
3	DERIVED	salaries	ALL	NULL	NULL	NULL	NULL	2838426	Using where

ANALYSIS ISSUES:
- Full Table Scan (ALL) detected.
